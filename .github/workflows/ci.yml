name: CI â€” SIG Reseau Paris

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:

  lint-python:
    name: Lint Python (flake8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Installer dependances
        run: |
          pip install flake8
          pip install -r etl/requirements.txt
      - name: Linter Python
        run: flake8 etl/ --max-line-length=120 --ignore=E501

  test-schema:
    name: Valider schema SQL
    runs-on: ubuntu-latest
    services:
      postgis:
        image: postgis/postgis:15-3.4
        env:
          POSTGRES_DB: reseau_eau_paris
          POSTGRES_USER: sig_user
          POSTGRES_PASSWORD: SigParis2024!
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Executer schema.sql
        run: |
          PGPASSWORD=SigParis2024! psql \
            -h localhost -U sig_user -d reseau_eau_paris \
            -f database/schema.sql
      - name: Executer seed_data.sql
        run: |
          PGPASSWORD=SigParis2024! psql \
            -h localhost -U sig_user -d reseau_eau_paris \
            -f database/seed_data.sql
      - name: Verifier les tables
        run: |
          PGPASSWORD=SigParis2024! psql \
            -h localhost -U sig_user -d reseau_eau_paris \
            -c "\dt"